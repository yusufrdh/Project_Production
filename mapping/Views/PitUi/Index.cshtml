@{
    ViewData["Title"] = "Pit Mapping"; 
    
    // Data Master
    var masterDivisions = ViewBag.Divisions as IEnumerable<dynamic> ?? new List<dynamic>();
    var masterLocations = ViewBag.Locations as IEnumerable<dynamic> ?? new List<dynamic>();
    var masterDepts = ViewBag.AllDepartments as IEnumerable<dynamic> ?? new List<dynamic>();

    var list = Model as IEnumerable<dynamic> ?? new List<dynamic>(); 
    var totalPit = list.Count();
    var activePit = list.Count(x => ((string)x.Status).Trim().ToUpper() == "ACTIVE");
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    body { background-color: #f4f6f8; font-family: 'Plus Jakarta Sans', sans-serif; letter-spacing: -0.2px; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* HERO & CARDS */
    .hero-solid { background-color: #D52B1E; box-shadow: 0 4px 20px rgba(213, 43, 30, 0.25); border-radius: 16px; }
    .card { border: 1px solid rgba(0,0,0,0.04); box-shadow: 0 2px 6px rgba(0,0,0,0.02); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background-color: #ffffff; }
    .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1); border-color: rgba(213, 43, 30, 0.3); }
    .form-control:focus, .form-select:focus { border-color: #D52B1E; box-shadow: 0 0 0 4px rgba(213, 43, 30, 0.1); }

    /* TABLE */
    .table-responsive { border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .table thead th { background-color: #f8fafc; color: #64748b; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; padding: 1rem; }
    .table-hover tbody tr { transition: background-color 0.2s; }
    .table-hover tbody tr:hover { background-color: #fff5f5 !important; }

    /* AVATAR & GRADIENTS */
    .avatar-initial { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 1.1rem; margin-right: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .bg-gradient-red { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }
    .bg-gradient-gray { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); }

    /* BUTTONS */
    .btn-action-icon { width: 38px; height: 38px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: all 0.2s; margin: 0 2px; border: 1px solid transparent; }
    .btn-edit-trigger { background-color: #f1f5f9; color: #475569; }
    .btn-edit-trigger:hover { background-color: #D52B1E; color: white !important; box-shadow: 0 4px 10px rgba(213, 43, 30, 0.3); transform: translateY(-2px); }
    .btn-delete-trigger { background-color: #fef2f2; color: #ef4444; }
    .btn-delete-trigger:hover { background-color: #dc2626; color: white !important; box-shadow: 0 4px 10px rgba(220, 38, 38, 0.3); transform: translateY(-2px); }

    /* --- STYLE CONFIG MASTER --- */
    .nav-pills-custom { background-color: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 5px; }
    .nav-pills-custom .nav-link { color: #64748b; font-weight: 600; border-radius: 8px; padding: 10px 20px; transition: all 0.2s; border: none; margin-bottom: 0 !important; }
    .nav-pills-custom .nav-link.active { background-color: #D52B1E !important; color: #ffffff !important; box-shadow: 0 4px 6px rgba(213, 43, 30, 0.25); }
    .nav-pills-custom .nav-link:hover:not(.active) { background-color: #f1f5f9; color: #D52B1E; }
    .config-card { background-color: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
</style>

<div class="p-4 mb-4 text-white position-relative overflow-hidden hero-solid">
    <div class="row align-items-center position-relative" style="z-index: 2;">
        <div class="col-md-8">
            <h1 class="fw-bold display-6 mb-2">Welcome to Pit Mapping</h1>
            <div class="d-flex flex-column gap-2 mt-3">
                <div class="d-flex align-items-center"><i class="bi bi-clock-history me-2 opacity-75"></i> <span class="opacity-75 me-2">Last updated:</span> <span class="fw-bold text-white">@ViewBag.LastUpdateStr</span></div>
                <div class="d-flex align-items-center small"><i class="bi bi-info-circle me-2 opacity-75"></i> <span class="opacity-75 me-2">Last Action:</span> <span class="fw-bold text-white">@ViewBag.LastUpdateMsg</span></div>
            </div>
        </div>
        <div class="col-md-4 text-end d-none d-md-block"><i class="bi bi-bar-chart-steps text-white" style="font-size: 4rem; opacity: 0.15;"></i></div>
    </div>
</div>

<div class="row mb-4 g-3">
    <div class="col-md-4"><div class="card h-100 hover-lift rounded-4 border-0"><div class="card-body d-flex align-items-center p-4"><div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger me-4" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;"><i class="bi bi-database-fill fs-3"></i></div><div><h6 class="text-muted mb-1 small fw-bold text-uppercase ls-1">Total Pit Mapping</h6><h2 class="fw-bold mb-0 text-dark">@totalPit</h2></div></div></div></div>
    <div class="col-md-4"><div class="card h-100 hover-lift rounded-4 border-0"><div class="card-body d-flex align-items-center p-4"><div class="bg-success bg-opacity-10 p-3 rounded-circle text-success me-4" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;"><i class="bi bi-check-circle-fill fs-3"></i></div><div><h6 class="text-muted mb-1 small fw-bold text-uppercase ls-1">Active Status</h6><h2 class="fw-bold mb-0 text-dark">@activePit</h2></div></div></div></div>
    <div class="col-md-4">
        <button type="button" class="card h-100 w-100 text-decoration-none hover-lift text-start border-0 rounded-4" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);" id="btnOpenCreateModal">
            <div class="card-body d-flex align-items-center justify-content-between p-4">
                <div><div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center mb-0 shadow-sm" style="width: 50px; height: 50px;"><i class="bi bi-plus-lg fs-4 text-dark fw-bold"></i></div></div>
                <div class="text-end"><span class="fw-bold d-block fs-4 text-white">Add New</span><span class="small text-white opacity-75">Click to create data</span></div>
            </div>
        </button>
    </div>
</div>

<div class="card shadow-sm mb-4 rounded-4 border-0">
    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center flex-wrap gap-2 rounded-top-4 px-4">
        <div><h5 class="fw-bold text-danger m-0"><i class="bi bi-table me-2"></i>Master Data List</h5></div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm fw-bold px-3 rounded-pill" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="bi bi-gear-fill me-1"></i> Config Master
            </button>
            <button onclick="exportExcel()" class="btn btn-success btn-sm fw-bold px-3 rounded-pill">
                <i class="bi bi-file-earmark-excel me-1"></i> Export Excel
            </button>
        </div>
    </div>
    
    <div class="card-body bg-light border-bottom py-3 px-4">
        <div class="row g-2">
            <div class="col-md-3"><div class="input-group"><span class="input-group-text bg-white border-end-0 text-secondary ps-3"><i class="bi bi-search"></i></span><input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Type to Search..." autocomplete="off"></div></div>
            <div class="col-md-3"><select id="filterDiv" class="form-select"><option value="">All Divisions</option>@foreach(var div in masterDivisions) { <option value="@div.DivisionName">@div.DivisionName</option> }</select></div>
            <div class="col-md-3"><select id="filterDept" class="form-select"><option value="">All Departments</option>@foreach(var dept in masterDepts) { <option value="@dept.DepartmentName">@dept.DepartmentName</option> }</select></div>
            <div class="col-md-3"><select id="filterStatus" class="form-select"><option value="">All Status</option><option value="ACTIVE">ACTIVE</option><option value="INACTIVE">INACTIVE</option></select></div>
        </div>
    </div>

    <div class="table-responsive rounded-bottom-4">
        <table class="table table-hover align-middle mb-0">
            <thead><tr><th class="ps-4">Pit Identity</th><th>Division</th><th>Department</th><th>Location</th><th class="text-center">Status</th><th class="text-center">Action</th></tr></thead>
            <tbody id="tableBody">
                @foreach (dynamic item in Model)
                {
                    string firstLetter = ((string)item.Name).Substring(0, 1).ToUpper();
                    string statusStr = ((string)item.Status).Trim().ToUpper();
                    bool isActive = statusStr == "ACTIVE";
                    <tr>
                        <td class="ps-4"><div class="d-flex align-items-center"><div class="avatar-initial @(isActive ? "bg-gradient-red" : "bg-gradient-gray")">@firstLetter</div><div><div class="fw-bold text-dark">@item.Name</div><div class="d-flex align-items-center gap-2 mt-1"><span class="badge bg-light text-dark border border-secondary text-xs">CODE: @item.Code</span>@if(item.Alias != "-") { <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 text-xs"><i class="bi bi-tag-fill me-1"></i> @item.Alias</span> }</div></div></div></td>
                        <td><span class="fw-bold text-dark" style="font-size: 0.9rem;">@item.Div</span></td>
                        <td><span class="text-muted small"><i class="bi bi-diagram-3"></i> @item.Dept</span></td>
                        <td><div class="text-secondary fw-bold"><i class="bi bi-geo-alt text-danger"></i> @item.Loc</div></td>
                        <td class="text-center">@if(isActive) { <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill fw-bold border border-success border-opacity-25">ACTIVE</span> } else { <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill fw-bold border border-secondary border-opacity-25">INACTIVE</span> }</td>
                        <td class="text-center">
                            <button class="btn btn-action-icon btn-edit-trigger" data-id="@item.Id" data-code="@item.Code" data-name="@item.Name" data-alias="@item.Alias" data-div="@item.Div" data-dept="@item.Dept" data-loc="@item.Loc" data-status="@statusStr"><i class="bi bi-pencil-square"></i></button>
                            <button class="btn btn-action-icon btn-delete-trigger" data-id="@item.Id"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4">
            
            <div class="modal-header bg-white border-bottom pb-3">
                <div>
                    <h5 class="modal-title fw-bold text-dark"><i class="bi bi-sliders me-2 text-danger"></i>Configuration Center</h5>
                    <p class="mb-0 text-muted small">Manage Divisions, Departments, and Locations</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body bg-light p-4">
                <ul class="nav nav-pills nav-justified nav-pills-custom mb-4" id="pills-tab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" id="pills-div-tab" data-bs-toggle="pill" data-bs-target="#pills-div" type="button">Divisions</button></li>
                    <li class="nav-item"><button class="nav-link" id="pills-dept-tab" data-bs-toggle="pill" data-bs-target="#pills-dept" type="button">Departments</button></li>
                    <li class="nav-item"><button class="nav-link" id="pills-loc-tab" data-bs-toggle="pill" data-bs-target="#pills-loc" type="button">Locations</button></li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    
                    <div class="tab-pane fade show active" id="pills-div">
                        <div class="config-card mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control border-end-0" id="new_div_name" placeholder="New Division Name...">
                                <button class="btn btn-danger px-4 fw-bold" onclick="saveMaster('Division')" style="min-width: 100px;">
                                    <i class="bi bi-plus-lg me-1"></i> Add
                                </button>
                            </div>
                        </div>
                        <div class="list-group shadow-sm rounded-3">
                            @foreach(var item in masterDivisions) {
                                <div class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                    <span class="fw-bold text-dark">@item.DivisionName</span>
                                    <div>
                                        <button class="btn btn-sm btn-light text-primary me-1" onclick="editMaster('Division', '@item.DivisionId', '@item.DivisionName')"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-sm btn-light text-danger" onclick="deleteMaster('Division', '@item.DivisionId')"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pills-dept">
                        <div class="config-card mb-3">
                            <div class="row g-2 align-items-center">
                                <div class="col-md-5">
                                    <select class="form-select" id="new_dept_div">
                                        <option value="">Select Parent Division...</option>
                                        @foreach(var div in masterDivisions) { <option value="@div.DivisionName">@div.DivisionName</option> }
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control" id="new_dept_name" placeholder="New Dept Name...">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-danger w-100 fw-bold" onclick="saveMaster('Department')">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="list-group shadow-sm rounded-3" style="max-height: 400px; overflow-y: auto;">
                            @foreach(var item in masterDepts) {
                                <div class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                    <div>
                                        <div class="fw-bold text-dark">@item.DepartmentName</div>
                                        <small class="text-muted"><i class="bi bi-diagram-2"></i> @item.Division?.DivisionName</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-light text-primary me-1" onclick="editMaster('Department', '@item.DepartmentId', '@item.DepartmentName')"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-sm btn-light text-danger" onclick="deleteMaster('Department', '@item.DepartmentId')"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pills-loc">
                        <div class="config-card mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control border-end-0" id="new_loc_name" placeholder="New Location Name...">
                                <button class="btn btn-danger px-4 fw-bold" onclick="saveMaster('Location')" style="min-width: 100px;">
                                    <i class="bi bi-plus-lg me-1"></i> Add
                                </button>
                            </div>
                        </div>
                        <div class="list-group shadow-sm rounded-3">
                            @foreach(var item in masterLocations) {
                                <div class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom">
                                    <span class="fw-bold text-dark">@item.LocationName</span>
                                    <div>
                                        <button class="btn btn-sm btn-light text-primary me-1" onclick="editMaster('Location', '@item.LocationId', '@item.LocationName')"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-sm btn-light text-danger" onclick="deleteMaster('Location', '@item.LocationId')"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header text-white" style="background-color: #D52B1E;">
                <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-plus me-2"></i>Add New Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 bg-light">
                <form id="createForm">
                    <div class="alert alert-light border shadow-sm small mb-4 d-flex align-items-center text-secondary rounded-3">
                        <i class="bi bi-magic text-danger fs-4 me-3"></i> <div>Pit Code (A, B, C...) will be <strong>Auto-Generated</strong> by System.</div>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold text-secondary text-uppercase">Pit Official Name <span class="text-danger">*</span></label><input type="text" class="form-control fw-bold py-2" id="create_name" placeholder="Enter Pit Official Name..."></div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label small fw-bold text-secondary text-uppercase">Division</label><select class="form-select py-2" id="create_division"><option value="">Select Division...</option>@foreach(var div in masterDivisions) { <option value="@div.DivisionName">@div.DivisionName</option> }<option value="NEW" class="fw-bold text-primary">+ Input Division Baru...</option></select><input type="text" class="form-control mt-2 border-primary" id="input_create_new_division" placeholder="Type New Division Name..." style="display:none;"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold text-secondary text-uppercase">Department</label><select class="form-select py-2" id="create_department" disabled><option value="">Select Division First...</option></select><input type="text" class="form-control mt-2 border-primary" id="input_create_new_dept" placeholder="Type New Dept Name..." style="display:none;"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label small fw-bold text-secondary text-uppercase">Location</label><select class="form-select py-2" id="create_location"><option value="">Select Location...</option>@foreach(var loc in masterLocations) { <option value="@loc.LocationName">@loc.LocationName</option> }<option value="NEW" class="fw-bold text-primary">+ Input Lokasi Baru...</option></select><input type="text" class="form-control mt-2 border-primary" id="input_create_new_location" placeholder="Type New Location..." style="display:none;"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold text-secondary text-uppercase">Status Role</label><select class="form-select py-2" id="create_status"><option value="ACTIVE">ACTIVE</option><option value="INACTIVE">INACTIVE</option></select></div>
                    </div>
                    <div class="mb-2"><label class="form-label small fw-bold text-secondary text-uppercase">Pit Alias (Optional)</label><input type="text" class="form-control border-danger border-opacity-25" id="create_alias" placeholder="e.g. Alias A, Alias B, Alias C..."></div>
                </form>
            </div>
            <div class="modal-footer bg-white border-top-0">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger px-4 fw-bold" style="background-color: #D52B1E;">
                    <i class="bi bi-save me-1"></i> Save Data
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header text-white" style="background-color: #D52B1E;">
                <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i>Edit Data Mapping</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 bg-light">
                <form id="editForm">
                    <input type="hidden" id="edit_id">
                    <div class="row mb-3">
                        <div class="col-md-4"><label class="form-label small fw-bold text-secondary">Pit Code (Locked)</label><input type="text" id="edit_code" class="form-control bg-white" readonly></div>
                        <div class="col-md-4"><label class="form-label small fw-bold text-secondary">Pit Official Name</label><input type="text" id="edit_name" class="form-control fw-bold text-danger"></div>
                        <div class="col-md-4"><label class="form-label small fw-bold text-secondary">Pit Alias</label><input type="text" id="edit_alias" class="form-control border-danger"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label small fw-bold text-secondary">Division</label><select class="form-select" id="edit_division"><option value="">Select Division...</option>@foreach(var div in masterDivisions) { <option value="@div.DivisionName">@div.DivisionName</option> }<option value="NEW" class="fw-bold text-primary">+ Input Division Baru...</option></select><input type="text" id="input_edit_new_division" class="form-control mt-2 border-primary" placeholder="Ketik Divisi Baru..." style="display:none;"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold text-secondary">Department</label><select class="form-select" id="edit_department"><option>Loading...</option></select><input type="text" id="input_edit_new_dept" class="form-control mt-2 border-primary" placeholder="Ketik Departemen Baru..." style="display:none;"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="form-label small fw-bold text-secondary">Location</label><select class="form-select" id="edit_location"><option value="">Select Location...</option>@foreach(var loc in masterLocations) { <option value="@loc.LocationName">@loc.LocationName</option> }<option value="NEW" class="fw-bold text-primary">+ Input Lokasi Baru...</option></select><input type="text" id="input_edit_new_location" class="form-control mt-2 border-primary" placeholder="Ketik Lokasi Baru..." style="display:none;"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold text-secondary">Status Role</label><select class="form-select fw-bold" id="edit_status"><option value="ACTIVE" class="text-success">ACTIVE</option><option value="INACTIVE" class="text-secondary">INACTIVE</option></select></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-white border-top-0">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger px-4 fw-bold" style="background-color: #D52B1E;">
                    <i class="bi bi-save me-1"></i> Save Data
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function exportExcel() {
            var search = $('#searchInput').val(); var div = $('#filterDiv').val(); var dept = $('#filterDept').val(); var status = $('#filterStatus').val();
            window.location.href = `/PitUi/ExportExcel?search=${encodeURIComponent(search)}&filterDiv=${encodeURIComponent(div)}&filterDept=${encodeURIComponent(dept)}&filterStatus=${encodeURIComponent(status)}`;
        }

        function saveMaster(type) {
            var name, divName = null;
            if(type === 'Division') name = $('#new_div_name').val();
            else if(type === 'Location') name = $('#new_loc_name').val();
            else if(type === 'Department') {
                name = $('#new_dept_name').val();
                divName = $('#new_dept_div').val();
                if(!divName) { Swal.fire('Error', 'Please select a Division first!', 'error'); return; }
            }

            if(!name) { Swal.fire('Error', 'Name cannot be empty!', 'error'); return; }

            $.post('/PitUi/SaveMaster' + type, { id: 0, name: name, divisionName: divName })
            .done(function() {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: type + ' Added Successfully!',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => location.reload());
            })
            .fail(function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: xhr.responseText || 'Failed to save data.',
                    confirmButtonColor: '#D52B1E'
                });
            });
        }

        function deleteMaster(type, id) {
            Swal.fire({ title: 'Delete ' + type + '?', text: "Ensure no Pit is using this data!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, delete!' }).then((result) => {
                if (result.isConfirmed) { $.post('/PitUi/DeleteMaster' + type, { id: id }, function() { location.reload(); }).fail(() => Swal.fire('Error', 'Cannot delete. Data might be in use.', 'error')); }
            })
        }

        function editMaster(type, id, oldName) {
            Swal.fire({
                title: 'Edit ' + type, input: 'text', inputValue: oldName,
                showCancelButton: true, confirmButtonColor: '#D52B1E', confirmButtonText: 'Update'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    $.post('/PitUi/SaveMaster' + type, { id: id, name: result.value, divisionName: 'DUMMY' }, function() { location.reload(); });
                }
            });
        }

        $(document).ready(function () {
            var $deptFilter = $('#filterDept');
            var allDeptOptions = $deptFilter.html();

            $('#filterDiv').change(function() {
                var selectedDiv = $(this).val();
                liveSearch();
                if (selectedDiv === "") { $deptFilter.html(allDeptOptions).val(''); } 
                else {
                    $deptFilter.empty().append('<option>Loading...</option>');
                    $.getJSON('/PitUi/GetDepartments?divisionName=' + encodeURIComponent(selectedDiv), function (data) {
                        $deptFilter.empty().append('<option value="">All Departments</option>');
                        $.each(data, function (index, item) { $deptFilter.append('<option value="' + item.name + '">' + item.name + '</option>'); });
                    });
                }
            });

            var debounceTimer;
            function liveSearch() {
                var searchVal = $('#searchInput').val(); var divVal = $('#filterDiv').val(); var deptVal = $('#filterDept').val(); var statusVal = $('#filterStatus').val();
                $.ajax({
                    url: '/PitUi/GetPitsJson', type: 'GET',
                    data: { search: searchVal, filterDiv: divVal, filterDept: deptVal, filterStatus: statusVal },
                    success: function (data) { renderTable(data); }
                });
            }

            $('#searchInput').on('input', function() { clearTimeout(debounceTimer); debounceTimer = setTimeout(liveSearch, 300); });
            $('#filterDept, #filterStatus').change(function() { liveSearch(); });

            function renderTable(data) {
                var tbody = $('#tableBody'); tbody.empty();
                if (data.length === 0) { tbody.append('<tr><td colspan="6" class="text-center py-5 text-muted fst-italic">No data found matching your criteria.</td></tr>'); return; }

                $.each(data, function(i, item) {
                    var statusClean = (item.status || "").toUpperCase().trim();
                    var isActive = statusClean === "ACTIVE";
                    var firstLetter = item.name.substring(0, 1).toUpperCase();
                    var avatarClass = isActive ? "bg-gradient-red" : "bg-gradient-gray";
                    var statusBadge = isActive ? '<span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill fw-bold border border-success border-opacity-25">ACTIVE</span>' : '<span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2 rounded-pill fw-bold border border-secondary border-opacity-25">INACTIVE</span>';
                    var aliasBadge = item.alias !== "-" ? `<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 text-xs"><i class="bi bi-tag-fill me-1"></i> ${item.alias}</span>` : '';

                    var row = `<tr>
                        <td class="ps-4"><div class="d-flex align-items-center"><div class="avatar-initial ${avatarClass}">${firstLetter}</div><div><div class="fw-bold text-dark">${item.name}</div><div class="d-flex align-items-center gap-2 mt-1"><span class="badge bg-light text-dark border border-secondary text-xs">CODE: ${item.code}</span>${aliasBadge}</div></div></div></td>
                        <td><span class="fw-bold text-dark" style="font-size: 0.9rem;">${item.div}</span></td>
                        <td><span class="text-muted small"><i class="bi bi-diagram-3"></i> ${item.dept}</span></td>
                        <td><div class="text-secondary fw-bold"><i class="bi bi-geo-alt text-danger"></i> ${item.loc}</div></td>
                        <td class="text-center">${statusBadge}</td>
                        <td class="text-center">
                            <button class="btn btn-action-icon btn-edit-trigger" data-id="${item.id}" data-code="${item.code}" data-name="${item.name}" data-alias="${item.alias}" data-div="${item.div}" data-dept="${item.dept}" data-loc="${item.loc}" data-status="${statusClean}"><i class="bi bi-pencil-square"></i></button>
                            <button class="btn btn-action-icon btn-delete-trigger" data-id="${item.id}"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
                    tbody.append(row);
                });
            }

            function saveDataToBackend(id, name, alias, div, dept, loc, status) {
                Swal.fire({title: 'Saving...', didOpen: () => { Swal.showLoading() }});
                $.ajax({
                    url: '/PitUi/SavePit', type: 'POST',
                    data: { id: id, name: name, alias: alias, division: div, department: dept, location: loc, status: status },
                    success: function (response) { Swal.fire('Success!', 'Data saved successfully.', 'success').then(() => { location.reload(); }); },
                    error: function (xhr) { 
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: xhr.responseText || 'Transaction failed.',
                            confirmButtonColor: '#D52B1E'
                        });
                    }
                });
            }

            function loadDepartments(divVal, targetDeptDropdown, targetNewDeptInput, selectedDept) {
                if (divVal === "NEW") { targetDeptDropdown.hide(); targetNewDeptInput.show().val(''); } 
                else if(divVal === "") { targetNewDeptInput.hide(); targetDeptDropdown.show().empty().append('<option value="">Select Division First...</option>').prop('disabled', true); } 
                else {
                    targetNewDeptInput.hide(); targetDeptDropdown.show().prop('disabled', false).empty().append('<option>Loading...</option>');
                    $.getJSON('/PitUi/GetDepartments?divisionName=' + encodeURIComponent(divVal), function (data) {
                        targetDeptDropdown.empty().append('<option value="">Select Department...</option>');
                        $.each(data, function (index, item) { targetDeptDropdown.append('<option value="' + item.name + '">' + item.name + '</option>'); });
                        targetDeptDropdown.append('<option value="NEW" class="fw-bold text-primary">+ Input Dept Baru...</option>');
                        if(selectedDept) targetDeptDropdown.val(selectedDept);
                    });
                }
            }

            $('#create_division, #edit_division').change(function() {
                var isEdit = $(this).attr('id').includes('edit'); var val = $(this).val();
                var inputDiv = isEdit ? $('#input_edit_new_division') : $('#input_create_new_division');
                var deptDropdown = isEdit ? $('#edit_department') : $('#create_department');
                var inputDept = isEdit ? $('#input_edit_new_dept') : $('#input_create_new_dept');
                if(val === 'NEW') inputDiv.slideDown().focus(); else inputDiv.slideUp();
                loadDepartments(val, deptDropdown, inputDept);
            });
            $('#create_department, #edit_department').change(function() { var isEdit = $(this).attr('id').includes('edit'); var inputDept = isEdit ? $('#input_edit_new_dept') : $('#input_create_new_dept'); if($(this).val() === 'NEW') inputDept.slideDown().focus(); else inputDept.slideUp(); });
            $('#create_location, #edit_location').change(function() { var isEdit = $(this).attr('id').includes('edit'); var inputLoc = isEdit ? $('#input_edit_new_location') : $('#input_create_new_location'); if($(this).val() === 'NEW') inputLoc.slideDown().focus(); else inputLoc.slideUp(); });

            $('#createForm').parent().parent().find('.btn-danger').click(function() {
                var name = $('#create_name').val(); if(!name) { Swal.fire('Error', 'Pit Name Wajib diisi!', 'warning'); return; }
                var div = $('#create_division').val() === 'NEW' ? $('#input_create_new_division').val() : $('#create_division').val();
                var dept = ($('#create_department').val() === 'NEW' || $('#create_division').val() === 'NEW') ? $('#input_create_new_dept').val() : $('#create_department').val();
                var loc = $('#create_location').val() === 'NEW' ? $('#input_create_new_location').val() : $('#create_location').val();
                saveDataToBackend(0, name, $('#create_alias').val(), div, dept, loc, $('#create_status').val());
            });

            $('#editModal .modal-footer button:last-child').click(function() {
                var div = $('#edit_division').val() === 'NEW' ? $('#input_edit_new_division').val() : $('#edit_division').val();
                var dept = ($('#edit_department').val() === 'NEW' || $('#edit_division').val() === 'NEW') ? $('#input_edit_new_dept').val() : $('#edit_department').val();
                var loc = $('#edit_location').val() === 'NEW' ? $('#input_edit_new_location').val() : $('#edit_location').val();
                saveDataToBackend($('#edit_id').val(), $('#edit_name').val(), $('#edit_alias').val(), div, dept, loc, $('#edit_status').val());
            });

            $(document).on('click', '.btn-edit-trigger', function() {
                $('#input_edit_new_division, #input_edit_new_dept, #input_edit_new_location').hide(); $('#edit_department').show();
                var id = $(this).data('id'); var code = $(this).data('code'); var name = $(this).data('name');
                var alias = $(this).data('alias'); var divFull = $(this).data('div'); var dept = $(this).data('dept'); var loc = $(this).data('loc'); var status = $(this).data('status');
                
                $('#edit_id').val(id); $('#edit_code').val(code); $('#edit_name').val(name); $('#edit_alias').val(alias === '-' ? '' : alias); $('#edit_status').val(status);
                $('#edit_location').val(loc); if(!$('#edit_location').val()) { $('#edit_location').val('NEW').change(); $('#input_edit_new_location').val(loc); }
                $('#edit_division').val(divFull); if(!$('#edit_division').val()) { $('#edit_division').val('NEW').change(); $('#input_edit_new_division').val(divFull); $('#input_edit_new_dept').val(dept); } else { loadDepartments(divFull, $('#edit_department'), $('#input_edit_new_dept'), dept); }
                $('#editModal').modal('show');
            });

            $(document).on('click', '.btn-delete-trigger', function() {
                var id = $(this).data('id');
                Swal.fire({ title: 'Are you sure?', text: "You won't be able to revert this!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, delete it!' }).then((result) => {
                    if (result.isConfirmed) { $.post('/PitUi/DeletePit', { id: id }, function() { location.reload(); }); }
                })
            });

            $('#btnOpenCreateModal').click(function() { $('#createForm')[0].reset(); $('#create_division').val('').change(); $('#create_location').val('').change(); $('#createModal').modal('show'); });

            $('#new_dept_div').change(function() {
                var selectedDiv = $(this).val(); 
                $('.dept-item').each(function() {
                    var itemDiv = $(this).data('div'); 
                    if (selectedDiv === "" || itemDiv === selectedDiv) { $(this).show(); } else { $(this).hide(); }
                });
            });
        });
    </script>
}